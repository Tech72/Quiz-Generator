<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap');
    
    :root {
        /* Light Mode Defaults */
        --main-color: #f3f4f6;
        --secondary-color: rgb(110, 110, 110);
        --layout-background: rgba(240, 240, 240, 0.25);
        --main-content-bg: rgba(240, 240, 240, 0.5);
        --secondary-content-bg: rgba(229, 231, 235, 0.5);
        --text-primary: rgb(31, 31, 31);
        --text-secondary: rgb(37, 37, 37);
        --layout-box-shadow: rgba(0, 0, 0, 0.1);
        --border-color: rgb(209, 213, 219);

        /* UI Colors (shared between modes) */
        --ui-green-bg: rgba(7, 177, 124, 0.3);
        --ui-green-fills: rgb(7, 177, 124);
        --ui-green-bg-hover: rgba(7, 177, 124, 0.35);

        --ui-blue-bg: rgba(71, 141, 255, 0.3);
        --ui-blue-fills: rgba(71, 141, 255);
        --ui-blue-bg-hover: rgba(71, 141, 255, 0.35);

        --ui-red-bg: rgba(255, 71, 71, 0.3);
        --ui-red-fills: rgba(255, 71, 71);
        --ui-red-bg-hover: rgba(255, 71, 71, 0.35);

        --ui-main-bg: rgba(229, 231, 235, 0.3);
        --ui-main-fills: rgba(107, 114, 128, 0.5);
        --ui-main-bg-hover: rgba(209, 213, 219, 0.5);
        --ui-main-fills-hover: rgba(55, 65, 81, 0.8);
    }

    html.dark {
        --main-color: rgba(10, 10, 10);
        --secondary-color: rgba(50, 50, 50);
        --layout-background: rgba(10,10,10,0.3);
        --main-content-bg: rgba(25,25,25,0.5);
        --secondary-content-bg: rgba(10, 10, 10, 0.6);
        --text-primary: rgba(240, 240, 240);
        --text-secondary: rgba(200, 200, 200);
        --layout-box-shadow: rgba(0, 0, 0, 0.3);
        --border-color: rgba(75, 75, 75, 0.1);

        --ui-main-bg: rgba(10, 10, 10, 0.35);
        --ui-main-fills: rgba(100, 100, 100, 0.5);
        --ui-main-bg-hover: rgba(50, 50, 50, 0.5);
        --ui-main-fills-hover: rgba(240, 240, 240, 0.8);
    }

    body {
        font-family: 'Figtree', sans-serif;
        background-color: var(--main-color); 
        transition: background-color 0.3s ease;
        color: var(--text-primary);
        overflow: hidden; 
        padding-top: 5rem;
        padding-bottom: 2.5rem;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box; 
    }

    #smudge-background-canvas { 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; 
        filter: blur(40px); /* Apply a large blur to the entire canvas */
    }

    #app {
       flex-grow: 1;
       position: relative;
       z-index: 1;
       display: flex;
       flex-direction: column;
    }

    .quiz-container, .top-controls-area, .app-footer {
        background-color: var(--layout-background); 
        backdrop-filter: blur(50px);
        -webkit-backdrop-filter: blur(50px); 
        box-shadow: 0px 0px 10px 1px var(--layout-box-shadow);
        border: 1px solid var(--border-color);
    }

    .quiz-container {
        width: 50rem;
        margin: 1rem auto;
        border-radius: 1.5rem; 
        position: relative;
        overflow-y: hidden; /* This will be managed by inner containers now */
        display: flex;
        flex-direction: column;
    }

    .btn {
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border-width: 0.15rem;
        border-style: solid;
        white-space: normal;
        line-height: 1.1;
        word-break: break-word; 
        /* Removed backdrop-filter from general buttons */
    }
    .btn:active {
        transform: translateY(1px);
    }

    .btn-blue {
        background-color: var(--ui-blue-bg);
        color: var(--ui-blue-fills);
        border-color: var(--ui-blue-fills);
    }
    .btn-blue:hover {
        background-color: var(--ui-blue-bg-hover);
        box-shadow: 0 0 1rem 0.2rem var(--ui-blue-fills);
    }
    .btn-green {
        background-color: var(--ui-green-bg);
        color: var(--ui-green-fills);
        border-color: var(--ui-green-fills);
    }
    .btn-green:hover {
        background-color: var(--ui-green-bg-hover);
        box-shadow: 0 0 1rem 0.2rem var(--ui-green-fills);
    }
    .btn-red {
        background-color: var(--ui-red-bg);
        color: var(--ui-red-fills);
        border-color: var(--ui-red-fills);
    }
    .btn-red:hover {
        background-color: var(--ui-red-bg-hover);
        box-shadow: 0 0 1rem 0.2rem var(--ui-red-fills);
    }
    .btn-main {
        background-color: var(--ui-main-bg);
        color: var(--text-primary);
        border-color: var(--ui-main-fills);
    }
    .btn-main:hover {
        background-color: var(--ui-main-bg-hover);
        border-color: none;
        box-shadow: 0 0 1rem 0.2rem var(--ui-main-fills-hover);
    }
    .btn-option {
        text-align: left;
        width: 100%;
        max-width: 100%;
        min-height: 3.5rem; 
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center; 
        line-height: 1.5;
        box-sizing: border-box;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .btn-option:disabled {
        cursor: not-allowed;
    }

    .btn-option.correct {
        background-color: var(--ui-green-bg) !important;
        color: white !important;
        border-color: var(--ui-green-fills) !important;
        /* Removed backdrop-filter */
    }
    .btn-option.incorrect {
        background-color: var(--ui-red-bg) !important;
        color: white !important;
        border-color: var(--ui-red-fills) !important;
        /* Removed backdrop-filter */
    }
    .btn-option.user-selected-option {
        border-color: var(--ui-main-fills-hover);
        /* Removed backdrop-filter */
    }

    .feedback-message {
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 0.75rem;
        font-weight: 500;
        animation: fadeIn 0.5s ease-out;
    }
    .feedback-correct {
        background-color: var(--secondary-content-bg);
        color: var(--text-primary);
        border: 1px solid var(--ui-green-fills);
    }
    .feedback-incorrect {
        background-color: var(--secondary-content-bg);
        color: var(--text-primary);
        border: 1px solid var(--ui-red-fills);
    }
    
    #input-screen {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding: 1.5rem;
    }
    .textarea-container {
        position: relative;
        width: 100%;
        flex-grow: 1;
        margin-top: 1rem;
        display: flex;
    }
    #quiz-data-input {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color);
        padding: 0.75rem; 
        width: 100%;
        font-family: 'Figtree';
        background-color: var(--main-content-bg);
        color: var(--text-primary);
        resize: none;
    }
    #textarea-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        color: var(--text-secondary);
        font-size: 1.25rem;
        opacity: 0.6;
    }
    #quiz-data-input:focus, #question-count-input:focus {
        outline: none;
        background-color: var(--ui-main-bg-hover);
        box-shadow: none;
    }
    .create-quiz-btn {
        margin-top: 1rem;
        font-size: 1.25rem;
    }
    
    /* --- Universal Scrollbar Styling (Revised) --- */
    #quiz-scrollable-content, 
    #quiz-data-input, 
    #results-details-container, 
    .timeline-nav-container, 
    #custom-select-options {
        overflow: auto; /* Ensure scrollability */
        /* For Firefox */
        scrollbar-width: auto; /* 'auto' is thicker than 'thin' */
    }

    /* For Webkit browsers (Chrome, Safari, Edge) */
    #quiz-scrollable-content::-webkit-scrollbar, 
    #quiz-data-input::-webkit-scrollbar, 
    #results-details-container::-webkit-scrollbar, 
    .timeline-nav-container::-webkit-scrollbar, 
    #custom-select-options::-webkit-scrollbar {
        width: 8px;  /* Thicker scrollbar */
        height: 8px; /* Thicker scrollbar for horizontal */
    }

    #quiz-scrollable-content::-webkit-scrollbar-track, 
    #quiz-data-input::-webkit-scrollbar-track, 
    #results-details-container::-webkit-scrollbar-track, 
    .timeline-nav-container::-webkit-scrollbar-track, 
    #custom-select-options::-webkit-scrollbar-track {
        background: transparent; /* Make the track invisible */
    }

    #quiz-scrollable-content::-webkit-scrollbar-thumb, 
    #quiz-data-input::-webkit-scrollbar-thumb, 
    #results-details-container::-webkit-scrollbar-thumb, 
    .timeline-nav-container::-webkit-scrollbar-thumb, 
    #custom-select-options::-webkit-scrollbar-thumb {
        background-color: var(--secondary-content-bg); /* Use requested variable */
        border-radius: 99px;
        background-clip: content-box; /* This is key for the padding effect */
    }

    #quiz-scrollable-content::-webkit-scrollbar-thumb:hover, 
    #quiz-data-input::-webkit-scrollbar-thumb:hover, 
    #results-details-container::-webkit-scrollbar-thumb:hover, 
    .timeline-nav-container::-webkit-scrollbar-thumb:hover, 
    #custom-select-options::-webkit-scrollbar-thumb:hover {
        background-color: var(--ui-main-bg-hover); /* Use requested hover variable */
    }

    /* Explicitly remove scrollbar arrows for Webkit */
    #quiz-scrollable-content::-webkit-scrollbar-button,
    #quiz-data-input::-webkit-scrollbar-button,
    #results-details-container::-webkit-scrollbar-button,
    .timeline-nav-container::-webkit-scrollbar-button,
    #custom-select-options::-webkit-scrollbar-button {
        display: none;
    }


    .line-break-1{
        border-width: 0.15rem;
        border-radius: 99px;
        border-color: var(--secondary-content-bg);
        width: 99.5%;
        align-self: center;
        margin-top: 0.5rem;
        margin-bottom: 0.1rem;
        justify-self: center;
    }
    
    .timeline-circle {
        min-width: 28px;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--ui-main-fills);
        border-radius: 50%;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.1s ease-in-out, transform 0.1s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
        background-color: var(--ui-main-bg);
        color: var(--text-secondary);
        position: relative;
        z-index: 1;
    }
    .timeline-line {
        height: 2px;
        background-color: var(--secondary-color);
        flex-grow: 1;
        min-width: 20px;
        margin: 0 -1px;
    }
    .timeline-circle:hover {
        transform: scale(1.3);
        border-color: var(--text-primary);
    } 
    .timeline-circle.current {
        transform: scale(1.6);
        background-color: var(--ui-blue-bg);
        color: white !important; 
        border-color: var(--ui-blue-fills);
        font-weight: 700;
        z-index: 2;
    }
    .timeline-circle.answered-correct {
        background-color: var(--ui-green-bg);
        color: white;
        border-color: var(--ui-green-fills);
    }
    .timeline-circle.answered-incorrect {
        background-color: var(--ui-red-bg);
        color: white;
        border-color: var(--ui-red-fills);
    }
    
    #results-screen:not(.hidden) {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 1.5rem;
    }

    .result-question-item { 
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        padding: 1rem;
        transition: all 0.3s ease-in-out; 
        border-left-width: 5px;
        background-color: var(--main-content-bg);
    }
    .result-question-item:last-child {
        margin-bottom: 0; /* Remove margin for last item */
    }
    .result-question-item.correct {
        border-left-color: var(--ui-green-fills);
    }
    .result-question-item.incorrect {
        border-left-color: var(--ui-red-fills);
    }
    .result-question-item.unanswered {
        border-left-color: var(--secondary-color);
    }
    .result-options-container { 
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        padding-top: 0;
        padding-bottom: 0; 
        border-left: 2px solid var(--secondary-color);
    }
    .result-options-container.expanded {
        max-height: 500px;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    .result-option {
        padding: 0.5rem;
        margin-bottom: 0.25rem;
        border-radius: 0.5rem;
        border: 1px solid transparent;
    }
    .result-option.user-selected {
        border: 2px solid var(--ui-main-fills-hover);
    }
    .result-option.correct-answer {
        background-color: var(--ui-green-bg);
        color: var(--ui-green-fills);
    }
    .result-option.user-selected.incorrect-answer {
        border: 2px solid var(--ui-main-fills-hover);
        background-color: var(--ui-red-bg);
    }
    .explanation-container {
        background-color: var(--secondary-content-bg);
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .dropdown-arrow {
        transition: transform 0.3s ease-in-out;
        margin-left: auto;
    }
    .dropdown-arrow.expanded {
        transform: rotate(180deg);
    }

    #results-details-container {
        flex-grow: 1;
        min-height: 0; /* Flexbox overflow fix */
    }

    #score-display-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
        transition: background-color 0.5s ease;
    }
    #score-display-container.default {
        background-color: rgba(96, 165, 250, 0.4);
        border: 0.15rem solid rgba(96, 165, 250, 0.5);
    }
    #score-display-container.gold {
        background-color: rgba(255, 175, 0, 0.4);
        border: 0.15rem solid rgba(255, 153, 0, 0.5);
    }
    #score-display-container.silver {
        background-color: rgba(192, 192, 192, 0.4);
        border: 0.15rem solid rgba(192, 192, 192, 0.5);
    }
    #score-display-container.bronze {
        background-color: rgba(102, 54, 7, 0.4);
        border: 0.15rem solid rgba(102, 54, 7, 0.5);
    }

    .top-controls-area {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 4rem;
        padding: 0.5rem 1rem; 
        display: flex;
        justify-content: space-between;
        align-items: center; 
        z-index: 1000;
        pointer-events: none;
        border: none;
    }
    .top-controls-area > div {
        pointer-events: auto;
    }
    .left-controls, .right-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .control-btn-group {
        background-color: var(--secondary-content-bg);
        border: 1px solid var(--border-color);
        border-radius: 9999px;
        padding: 0.25rem;
        display: flex;
    }
    .control-button { 
        transition: all 0.2s ease-in-out;
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease, color 0.3s ease;
        cursor: pointer;
        background-color: transparent;
        border: none;
        color: var(--text-primary);
    }
    .control-button:hover {
        transition: all 0.2s ease-in-out;
        background-color: var(--main-content-bg);
        border: 0.15rem solid var(--ui-main-fills-hover);
    }
    .control-button.active {
        transition: all 0.2s ease-in-out;
        background-color: var(--ui-blue-bg);
        color: var(--ui-blue-fills) !important;
        border: 0.15rem solid var(--ui-blue-fills);
    } 
    .control-button svg {
        width: 1.25rem;
        height: 1.25rem;
        stroke-width: 1.5;
    } 
    #change-palette-btn svg {
        fill: var(--secondary-color);
    }
    #change-palette-btn.dark-mode-toggle-unselected-fill svg {
        fill: var(--secondary-color);
    }
    #change-palette-btn:hover svg {
        fill: var(--text-primary);
    }

    .external-quiz-action-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        height: 2.5rem;
    }
    .external-quiz-action-btn:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    #pause-modal { z-index: 2000; }
    #confirmation-modal { z-index: 2100; } /* Higher z-index */
    #format-error-modal { z-index: 2100; }

    .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-content {
        background-color: var(--main-content-bg);
        padding: 2rem;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 400px;
        text-align: center;
        transform: scale(0.95);
        transition: transform 0.3s ease;
        border: 1px solid var(--border-color);
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-content h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
    }
    .modal-content p {
        font-size: 1rem;
        color: var(--text-secondary);
    }
    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .app-footer {
        font-size: 0.75rem;
        padding: 3px 0.5rem;
        width: 100%;
        position: fixed;
        left: 0;
        bottom: 0;
        right: 0;
        color: var(--text-primary);
        height: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: none;
    }
    .app-footer > p {
        flex: 1; /* Prevent growing, allow shrinking */
    }
    .author-credits {
        text-align: center;
    }
    .version-info {
        text-align: left;
    }
    .last-updated {
        text-align: right;
    }

    #quiz-screen {
        position: relative;
        flex-grow: 1; 
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    #quiz-sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--layout-background);
        padding: 2rem 2rem 0 2rem;
        flex-shrink: 0;
    }

    #quiz-scrollable-content {
        flex-grow: 1;
        min-height: 0;
        overflow-x: hidden; /* Prevent horizontal scroll during question transition */
        padding: 0.75rem 1.5rem 0.75rem 1.5rem;
        display: flex;
        flex-direction: column;
    }

    #quiz-bottom-controls {
        margin-top: auto; /* Pushes to the bottom */
        padding-top: 1rem;
    }

    #prompt-builder-container {
        border-radius: 0.75rem;
        border: 1px solid var(--border-color); 
        padding: 1rem;
        width: 100%;
        font-family: 'Figtree';
        background-color: var(--main-content-bg);
        color: var(--text-primary);
        position: relative;
        padding-bottom: 50px;
    }
    .prompt-builder-row {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        width: max-content;
    }
    
    #custom-select-trigger {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 12rem;
        padding: 0.35rem 0.75rem;
        border-radius: 0.75rem;
        backdrop-filter: none;
        border: none;
    }
    #custom-select-options {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background-color: var(--main-content-bg);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        z-index: 10;
        max-height: 200px;
        scrollbar-gutter: stable; /* Reserve space for scrollbar to prevent layout shift */
        /* Removed backdrop-filter */
    }
    .custom-option {
        padding: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .custom-option:hover {
        background-color: var(--ui-main-bg-hover);
    }
    .custom-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: transparent !important;
    }
    .custom-option:first-child { border-top-left-radius: 0.75rem;}
    .custom-option:last-child { border-bottom-left-radius: 0.75rem;}

    .number-input-container {
        display: flex; 
        align-items: center; 
        flex-grow: 1;
        border: none;
        border-radius: 0.75rem;
        overflow: hidden;
    }
    #question-count-input {
        width: 2.5rem; 
        padding: 0.35rem 0.1rem; 
        text-align: center;
        background-color: var(--ui-main-bg);
        color: var(--text-primary);
        border: none;
    }
    #question-count-input::-webkit-outer-spin-button, #question-count-input::-webkit-inner-spin-button {
        -webkit-appearance: none; 
        margin: 0;
    }
    .number-input-btn {
        padding: 0.35rem 0.5rem; 
        background-color: var(--ui-main-bg);
        cursor: pointer; 
        transition: background-color 0.2s;
        min-width: 1.5rem; 
        color: var(--text-primary); 
        border: none;
        height: 100%;
    }
    .number-input-btn:hover {
        background-color: var(--ui-main-bg-hover);
    }
    .number-input-btn:active {
        background-color: var(--ui-main-fills-hover);
        transition: ease-out 0.3s;
    }

    .copy-format-btn {
        border-bottom: none;
        border-left: none;
        border-right: none; 
        border-top: none;
        background-color: var(--ui-main-bg);
        backdrop-filter: none;
    }

    .hidden {
        display: none !important;
    }
    @keyframes fadeInScreen {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .screen {
        animation: fadeInScreen 0.3s ease-out;
    }

    @media (max-width: 600px) {
    .app-footer {
        justify-content: space-around;
    }
    .app-footer > p {
        flex-grow: 1;
        flex-shrink: 1;
        flex-basis: auto;
    } }

</style>
</head>
<body>
    <canvas id="smudge-background-canvas"></canvas> 
    <div class="top-controls-area">
        <div class="left-controls">
            <div id="theme-toggle" class="control-btn-group">
                <button id="light-mode-btn" class="control-button" aria-label="Activate light mode">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                </button>
                <button id="dark-mode-btn" class="control-button" aria-label="Activate dark mode">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                </button>
            </div>
            <div id="palette-changer-group" class="control-btn-group">
                <button id="change-palette-btn" class="control-button" aria-label="Change color palette">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-5 h-5">
                       <path d="M19 2L15.586 5.414C14.8049 6.1951 14.8049 7.46144 15.586 8.2425L16.01 8.6669C16.7956 9.45247 18.057 9.44908 18.8381 8.66801L22 5.50612V19C22 20.1046 21.1046 21 20 21H4C2.89543 21 2 20.1046 2 19V5C2 3.89543 2.89543 3 4 3H19V2ZM4 5V19H20V12L17.4142 9.41421C17.0391 9.03914 16.406 9.03914 16.0309 9.41421L15.586 9.8586C14.8049 10.6397 13.5386 10.6397 12.7575 9.8586L11.1619 8.26299C10.3808 7.48192 9.11447 7.48192 8.3334 8.26299L5 11.5964V5H19V4H4C3.44772 4 3 4.44772 3 5V19C3 19.5523 3.44772 20 4 20H20C20.5523 20 21 19.5523 21 19V5.50612C21 5.43001 20.9819 5.35531 20.9477 5.28886C20.9135 5.22241 20.8644 5.16586 20.8046 5.1243L18.8381 3.66801C18.5516 3.44908 18.1843 3.32754 17.8046 3.3243L17.1954 3.3243C16.8157 3.32754 16.4484 3.44908 16.1619 3.66801L15.586 4.2425C15.2108 4.61828 15.2108 5.25144 15.586 5.62722L16.0309 6.07163C16.812 6.8527 18.0783 6.8527 18.8594 6.07163L19 5.93103V2Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="right-controls">
            <button id="pause-quiz-btn-ext" class="external-quiz-action-btn btn btn-blue hidden">Pause</button>
            <button id="submit-quiz-early-btn-ext" class="external-quiz-action-btn btn btn-red hidden">Submit Quiz</button>
            
            <button id="redo-incorrect-btn-ext" class="external-quiz-action-btn btn btn-green hidden">Redo Incorrect</button>
            <button id="redo-quiz-btn-ext" class="external-quiz-action-btn btn btn-blue hidden">Retake Quiz</button>
            <button id="new-quiz-btn-ext" class="external-quiz-action-btn btn btn-red hidden">New Quiz</button>
        </div>
    </div>

    <div id="app" class="quiz-container">
        <div id="input-screen" class="screen">
            <h1 class="text-3xl font-bold mb-4 text-center">Quiz Generator For AI Models</h1>

            <div id="prompt-builder-container">
                <ol class="list-decimal list-inside space-y-2 text-secondary">
                    <li>
                        <div class="prompt-builder-row">
                            <span>Select your AI Model:</span>
                            <div id="custom-select-container" class="relative">
                                <button id="custom-select-trigger" class="btn btn-main">
                                    <span id="custom-select-value">Choose an AI Model</span>
                                    <div class="select-arrow">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </button>
                                <div id="custom-select-options" class="hidden">
                                    <div class="custom-option" data-value="chatgpt">ChatGPT</div>
                                    <div class="custom-option" data-value="chatgpt-plus">ChatGPT Plus</div>
                                    <div class="custom-option" data-value="notebook-lm">Notebook LM</div>
                                    <div class="custom-option" data-value="gemini">Gemini</div>
                                    <div class="custom-option disabled" data-value="claude">Claude</div>
                                    <div class="custom-option disabled" data-value="deepseek">Deepseek</div>
                                    <div class="custom-option disabled" data-value="llama">Llama</div>
                                </div>
                                <input type="hidden" id="ai-model-select-hidden">
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="prompt-builder-row">
                            <span>Enter number of questions:</span>
                            <div class="number-input-container">
                                <input type="number" id="question-count-input" min="1" value="10">
                                <button class="number-input-btn" id="q-count-minus-btn">-</button>
                                <button class="number-input-btn" id="q-count-plus-btn">+</button>
                                <button class="number-input-btn" id="q-count-max-btn">MAX</button>
                            </div>
                        </div>
                    </li>
                    <li>
                        Copy the prompt by clicking the button below and add any other limits to the end of the prompt e.g
                        <em>&nbsp;**Copied Prompt** "Only use content from the lecture on the  <span id="today-date"></span>”</em>
                    </li>
                </ol>

                <button id="copy-format-btn" class="absolute bottom-0 left-0 w-full btn btn-main rounded-t-none copy-format-btn">
                    Required Prompt. Click to Copy
                </button>
            </div>

            <div class="textarea-container">
                <textarea id="quiz-data-input"></textarea>
                <div id="textarea-placeholder">Paste the quiz response from your AI model here...</div>
            </div>
            
            <button id="create-quiz-btn" class="btn btn-blue create-quiz-btn">Create Quiz</button>
        </div>

        <div id="quiz-screen" class="hidden screen">
            <div id="quiz-sticky-header">
                 <div class="flex justify-between items-center mb-2">
                    <h2 id="quiz-screen-title" class="text-2xl font-semibold text-right">Question 1</h2>
                    <div id="current-question-timer" class="question-timer">Time: 0s</div>
                </div>
                <p id="sticky-question-text" class="whitespace-normal break-words text-lg leading-relaxed mb-2 max-w-full"></p>
            </div>
            
            <div id="quiz-scrollable-content">
                <div id="question-content-slider" class="flex transition-transform duration-300 ease-in-out w-full"></div>
                
                <div id="quiz-bottom-controls">
                    <button id="submit-answer-btn" class="btn btn-blue w-full">Submit Answer</button>
                    <hr class="line-break-1">
                    <div id="timeline-nav-container" class="timeline-nav-container w-full max-w-full p-0">
                        <div id="timeline-nav-track" class="flex items-center p-2 min-w-min h-[60px]"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="results-screen" class="hidden screen">
            <h2 id="results-title" class="text-3xl font-bold mb-4 text-center">Quiz Complete!</h2>
            <div id="score-display-container">
                <div class="score-left-panel">
                    <div id="score-percentage" class="text-4xl font-bold">0%</div>
                    <div id="score-details" class="text-sm">0/0 correct</div>
                </div>
                <div class="score-right-panel text-sm text-right">
                    <p id="score-message"></p>
                    <p>Total Quiz Time: <strong id="total-quiz-time">0s</strong></p>
                </div>
            </div>
            <h3 class="text-xl font-semibold mb-4">Review Your Answers:</h3>
            <div id="results-details-container"></div>
        </div>
    </div>

    <footer class="app-footer">
        <p class="version-info">v1.2.9</p> 
        <p class="author-credits">Made by Pranay Bhana with Gemini</p> 
        <p class="last-updated">Last Updated: 25th August 2025</p>
    </footer>

    <!-- Modals -->
    <div id="pause-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-3xl font-bold mb-6 text-center">Quiz Paused</h3>
            <div class="text-center space-y-2 mb-8">
                <p class="text-lg">Current Score: <strong id="paused-score">0/0 (0%)</strong></p>
                <p class="text-lg">Questions Remaining: <strong id="paused-remaining">0</strong></p>
                <p class="text-lg">Total Time Elapsed: <strong id="paused-time">0s</strong></p>
            </div>
            <div class="modal-buttons flex-col sm:flex-row space-y-3 sm:space-y-0">
                <button id="resume-quiz-btn" class="btn btn-green w-full sm:w-auto">Resume Quiz</button> 
                <button id="redo-quiz-paused-btn" class="btn btn-blue w-full sm:w-auto">Retake Quiz</button> 
                <button id="end-quiz-early-btn" class="btn btn-red w-full sm:w-auto">Submit Quiz</button> 
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">Are you sure?</h3>
            <p id="modal-message">This action cannot be undone.</p>
            <div class="modal-buttons mt-6">
                <button id="modal-confirm-btn" class="btn btn-red">Confirm</button>
                <button id="modal-cancel-btn" class="btn btn-main">Cancel</button>
            </div>
        </div>
    </div>

    <div id="format-error-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="format-modal-title" style="color: var(--ui-red-fills);">Incorrect Format!</h3>
            <p id="format-modal-message" class="text-left">Please check your prompt's format or try generating another answer from your AI model (ensure to refresh the AI model's page if you do this).</p>
            <p class="text-left font-semibold my-2">The correct format should look like this:</p>
            <pre class="bg-secondary-content-bg p-2 rounded text-left text-sm whitespace-pre-wrap">1. Which planet is known as the Red Planet?
    A. Venus.
    B. **Mars. [explanation] Mars is often called the Red Planet due to its iron oxide-rich surface.**
    C. Jupiter.
    D. Earth.</pre>
            <div class="modal-buttons mt-6">
                <button id="format-modal-ok-btn" class="btn btn-green">I understand</button>
            </div>
        </div>
    </div>


    <script>
        // DOM Elements
        const docHtml = document.documentElement;
        const bodyElement = document.body;
        const lightModeBtn = document.getElementById('light-mode-btn');
        const darkModeBtn = document.getElementById('dark-mode-btn');
        const changePaletteBtn = document.getElementById('change-palette-btn');
        const externalPauseBtn = document.getElementById('pause-quiz-btn-ext');
        const externalSubmitEarlyBtn = document.getElementById('submit-quiz-early-btn-ext');

        const inputScreen = document.getElementById('input-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const quizScreenTitle = document.getElementById('quiz-screen-title');
        const resultsScreen = document.getElementById('results-screen');
        const resultsTitle = document.getElementById('results-title');
        const stickyQuestionText = document.getElementById('sticky-question-text');

        // --- Custom Select Dropdown Elements ---
        const customSelectContainer = document.getElementById('custom-select-container');
        const customSelectTrigger = document.getElementById('custom-select-trigger');
        const customSelectValue = document.getElementById('custom-select-value');
        const customSelectOptions = document.getElementById('custom-select-options');
        const hiddenSelectInput = document.getElementById('ai-model-select-hidden');

        const questionCountInput = document.getElementById('question-count-input');
        const qCountMinusBtn = document.getElementById('q-count-minus-btn');
        const qCountPlusBtn = document.getElementById('q-count-plus-btn');
        const qCountMaxBtn = document.getElementById('q-count-max-btn');
        const todayDateSpan = document.getElementById('today-date');
        const copyFormatBtn = document.getElementById('copy-format-btn');

        const quizDataInput = document.getElementById('quiz-data-input');
        const textareaPlaceholder = document.getElementById('textarea-placeholder');
        const createQuizBtn = document.getElementById('create-quiz-btn');

        const currentQuestionTimerDisplay = document.getElementById('current-question-timer');
        
        const questionContentSlider = document.getElementById('question-content-slider');
        let currentQuestionDOM = null; 

        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        
        const timelineNavContainer = document.getElementById('timeline-nav-container');
        const timelineNavTrack = document.getElementById('timeline-nav-track');
        
        const scoreDisplayContainer = document.getElementById('score-display-container'); 
        const scorePercentageDisplay = document.getElementById('score-percentage');
        const scoreDetailsDisplay = document.getElementById('score-details');
        const scoreMessageDisplay = document.getElementById('score-message');
        const totalQuizTimeDisplay = document.getElementById('total-quiz-time');
        const resultsDetailsContainer = document.getElementById('results-details-container');

        // --- Modal Elements ---
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        let confirmActionCallback = null;

        const pauseModal = document.getElementById('pause-modal');
        const resumeQuizBtn = document.getElementById('resume-quiz-btn');
        const pausedScoreDisplay = document.getElementById('paused-score');
        const pausedRemainingDisplay = document.getElementById('paused-remaining');
        const pausedTimeDisplay = document.getElementById('paused-time');
        const redoQuizPausedBtn = document.getElementById('redo-quiz-paused-btn');
        const endQuizEarlyBtn = document.getElementById('end-quiz-early-btn'); 

        const formatErrorModal = document.getElementById('format-error-modal');
        const formatModalOkBtn = document.getElementById('format-modal-ok-btn');

        const redoIncorrectBtnExt = document.getElementById('redo-incorrect-btn-ext');
        const redoQuizBtnExt = document.getElementById('redo-quiz-btn-ext');
        const newQuizBtnExt = document.getElementById('new-quiz-btn-ext');

        // Quiz State Variables
        let originalAllQuestionsData = []; 
        let currentQuizQuestions = []; 
        let questionOrder = []; 
        let currentQuestionDisplayOrderIndex = 0; 
        let currentTimerInterval = null;
        let questionSpecificTimerStartMs = 0; 
        let totalQuizTimerStartMs = 0; 
        let accumulatedTotalQuizTimeMs = 0; 
        let selectedOptionLetter = null;
        let isQuizPaused = false;
        let isQuizActive = false;
        let autoAdvanceTimeout = null;
        
        let isTimelineDragging = false;
        let timelineStartX;
        let timelineScrollLeftStart;
        let copyTimeout = null;

        // --- SMUDGE ANIMATED BACKGROUND LOGIC ---
        const smudgeBackgroundCanvas = document.getElementById('smudge-background-canvas');
        const smudgeCtx = smudgeBackgroundCanvas.getContext('2d');

        const backgroundPalettes = {
            light: [
                ['#FF6B6B', '#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#4ECDC4', '#BDBDBD', '#7209B7'], 
                ['#fa873f', '#f46f5e', '#ee577e', '#AED581', '#e127bd', '#f093de', '#3cd19d', '#00BCD4'], 
                ['#FF8C00', '#FFD700', '#ADFF2F', '#00CED1', '#FF69B4', '#BA55D3', '#FFA07A', '#20B2AA'], 
                ['#A8DADC', '#C5E1A5', '#457B9D', '#1D3557', '#E63946', '#F4A261', '#2A9D8F', '#E9C46A']
            ],
            dark: [
                ['#7209B7', '#3A0CA3', '#F72585', '#B5179E', '#FDB99B', '#FF8A65', '#EF476F', '#00F5D4'], 
                ['#975E8E', '#9E9E9E', '#5188A3', '#268FC2', '#079CE4', '#01685B', '#7DB246', '#CDDC3C'], 
                ['#fd1d1d', '#F3722C', '#F8961E', '#F9844A', '#F9C74F', '#fd1d1d', '#EC407A', '#833ab4'], 
                ['#C62828', '#616161', '#0BB9FF', '#FF6F00', '#06CF00', '#8338EC', '#FF006E', '#FFBE0B']
            ]
        };
        let currentBgPaletteIndices = { light: 0, dark: 0 }; 
        let smudgeEffectColors = [...backgroundPalettes.light[0]];

        let smudgeCircles = [];
        const numSmudgeCircles = 10; // Reduced particle count

        function resizeSmudgeCanvas() {
            smudgeBackgroundCanvas.width = window.innerWidth;
            smudgeBackgroundCanvas.height = window.innerHeight;
            if (smudgeEffectColors.length > 0) { 
                 initSmudgeEffect();
            }
        }
        
        class SmudgeCircle {
            constructor(canvasWidth, canvasHeight) {
                this.canvasWidth = canvasWidth;
                this.canvasHeight = canvasHeight;
                
                const smallerDimension = Math.min(this.canvasWidth, this.canvasHeight);
                // Increased particle size by 2x
                this.radius = (Math.random() * (smallerDimension * 0.4) + (smallerDimension * 0.5)) * 2; 
                
                this.x = Math.random() * (this.canvasWidth + 2 * this.radius) - this.radius;
                this.y = Math.random() * (this.canvasHeight + 2 * this.radius) - this.radius;
                
                this.color = smudgeEffectColors[Math.floor(Math.random() * smudgeEffectColors.length)];
                this.targetColor = this.color;
                
                this.vx = (Math.random() - 0.5) * 0.5; 
                this.vy = (Math.random() - 0.5) * 0.5; 
                
                // New animation properties
                this.opacity = 0; // Start dark (transparent)
                this.targetOpacity = Math.random() * 0.2 + 0.6;
                this.creationTime = performance.now();
                this.animationCompleted = false;
                this.colorChangeSpeed = 0.0005;
            }

            update() {
                // Movement logic
                this.x += this.vx;
                this.y += this.vy;

                if (this.x - this.radius > this.canvasWidth) { this.x = -this.radius; } 
                else if (this.x + this.radius < 0) { this.x = this.canvasWidth + this.radius; }
                if (this.y - this.radius > this.canvasHeight) { this.y = -this.radius; } 
                else if (this.y + this.radius < 0) { this.y = this.canvasHeight + this.radius; }
                
                // New opacity animation logic
                if (!this.animationCompleted) {
                    const age = performance.now() - this.creationTime;
                    const animationDuration = 3000; // 3 seconds
                    if (age < animationDuration) {
                        // Simple linear ramp-up from dark to bright
                        this.opacity = this.targetOpacity * (age / animationDuration);
                    } else {
                        this.opacity = this.targetOpacity;
                        this.animationCompleted = true; // End initial animation
                    }
                } else {
                    // After initial animation, do gentle fluctuations
                    if (Math.random() < 0.005) { // Occasionally pick a new target opacity
                        this.targetOpacity = Math.random() * 0.2 + 0.6;
                    }
                    // Slowly move towards the target opacity
                    if (this.opacity < this.targetOpacity) {
                        this.opacity = Math.min(this.targetOpacity, this.opacity + 0.001);
                    } else if (this.opacity > this.targetOpacity) {
                        this.opacity = Math.max(0, this.opacity - 0.001);
                    }
                }

                // Color transition logic
                if (this.color !== this.targetColor) {
                    const c1 = hexToRgbSmudge(this.color);
                    const c2 = hexToRgbSmudge(this.targetColor);
                    if (c1 && c2) {
                        let r = c1.r + (c2.r - c1.r) * this.colorChangeSpeed;
                        let g = c1.g + (c2.g - c1.g) * this.colorChangeSpeed;
                        let b = c1.b + (c2.b - c1.b) * this.colorChangeSpeed;
                        this.color = rgbToHexSmudge(Math.floor(r), Math.floor(g), Math.floor(b));
                        if (Math.abs(r - c2.r) < 2 && Math.abs(g - c2.g) < 2 && Math.abs(b - c2.b) < 2) {
                            this.color = this.targetColor; 
                        }
                    }
                } else if (Math.random() < 0.002) { 
                    this.targetColor = smudgeEffectColors[Math.floor(Math.random() * smudgeEffectColors.length)];
                }
            }

            draw(ctx) {
                ctx.beginPath();
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.radius);
                const baseColor = hexToRgbSmudge(this.color);
                if (baseColor) {
                    gradient.addColorStop(0, `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, ${this.opacity})`); 
                    gradient.addColorStop(0.6, `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, ${this.opacity * 0.4})`);
                    gradient.addColorStop(1, `rgba(${baseColor.r}, ${baseColor.g}, ${baseColor.b}, 0)`); 
                }
                ctx.fillStyle = gradient; ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill();
            }
        }
        function hexToRgbSmudge(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
        function componentToHexSmudge(c) { const hex = c.toString(16); return hex.length == 1 ? "0" + hex : hex; }
        function rgbToHexSmudge(r, g, b) { return "#" + componentToHexSmudge(r) + componentToHexSmudge(g) + componentToHexSmudge(b); }
        function initSmudgeEffect() {
            if (!smudgeEffectColors || smudgeEffectColors.length === 0) smudgeEffectColors = backgroundPalettes.light[0]; 
            smudgeCircles = [];
            for (let i = 0; i < numSmudgeCircles; i++) smudgeCircles.push(new SmudgeCircle(smudgeBackgroundCanvas.width, smudgeBackgroundCanvas.height));
        }
        function animateSmudgeBackground() {
            smudgeCtx.clearRect(0, 0, smudgeBackgroundCanvas.width, smudgeBackgroundCanvas.height);
            smudgeCtx.globalCompositeOperation = 'lighter'; 
            // Removed per-particle blur. The blur is now on the canvas element via CSS.
            smudgeCircles.forEach(circle => { circle.update(); circle.draw(smudgeCtx); });
            smudgeCtx.globalCompositeOperation = 'source-over'; 
            requestAnimationFrame(animateSmudgeBackground);
        }
        function applyBackgroundPalette() {
            const isDarkMode = docHtml.classList.contains('dark');
            const modeKey = isDarkMode ? 'dark' : 'light';
            const palettesForMode = backgroundPalettes[modeKey];
            if (palettesForMode && palettesForMode.length > 0) {
                const currentPalette = palettesForMode[currentBgPaletteIndices[modeKey]];
                if (currentPalette && currentPalette.length > 0) smudgeEffectColors = [...currentPalette];
                else smudgeEffectColors = [...palettesForMode[0]];
            } else smudgeEffectColors = [...backgroundPalettes.light[0]];
            initSmudgeEffect(); 
        }
        changePaletteBtn.addEventListener('click', () => { 
            const isDarkMode = docHtml.classList.contains('dark');
            const modeKey = isDarkMode ? 'dark' : 'light';
            if (backgroundPalettes[modeKey] && backgroundPalettes[modeKey].length > 0) {
                currentBgPaletteIndices[modeKey] = (currentBgPaletteIndices[modeKey] + 1) % backgroundPalettes[modeKey].length;
                localStorage.setItem('bgPaletteIndex_' + modeKey, currentBgPaletteIndices[modeKey]);
                applyBackgroundPalette(); 
            }
        });
        function setLightMode() {
            docHtml.classList.remove('dark'); lightModeBtn.classList.add('active'); darkModeBtn.classList.remove('active');
            localStorage.setItem('quizTheme', 'light'); applyBackgroundPalette();
        }
        function setDarkMode() {
            docHtml.classList.add('dark'); darkModeBtn.classList.add('active'); lightModeBtn.classList.remove('active');
            localStorage.setItem('quizTheme', 'dark'); applyBackgroundPalette();
        }
        lightModeBtn.addEventListener('click', setLightMode);
        darkModeBtn.addEventListener('click', setDarkMode);
        function loadTheme() {
            currentBgPaletteIndices.light = parseInt(localStorage.getItem('bgPaletteIndex_light') || '0');
            currentBgPaletteIndices.dark = parseInt(localStorage.getItem('bgPaletteIndex_dark') || '0');
            const preferredTheme = localStorage.getItem('quizTheme');
            if (preferredTheme === 'dark') setDarkMode();
            else setLightMode(); 
        }
        function shuffleArray(array) { 
            for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
            return array;
        }
        function formatTime(milliseconds) { 
            const totalSeconds = Math.floor(milliseconds / 1000);
            if (totalSeconds < 0) return '0s'; 
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }
        function parseInput(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '' || line === '');
            const questions = [];
            let currentQuestionBuilder = null;
            const questionRegex = /^(\d+)\.\s+(.*)/;
            const optionRegex = /^\s*([A-Z])\.\s+(.*)/;
            const explanationRegex = /\[explanation\](.*)/;
            let questionNumber = 0;

            for (const line of lines) {
                const trimmedLine = line.trim();
                const questionMatch = trimmedLine.match(questionRegex);
                const optionMatch = trimmedLine.match(optionRegex);

                if (questionMatch) {
                    if (currentQuestionBuilder && currentQuestionBuilder.options.length > 0 && currentQuestionBuilder.options.some(opt => opt.isCorrectOption)) {
                        questions.push(currentQuestionBuilder);
                    }
                    questionNumber = parseInt(questionMatch[1], 10);
                    currentQuestionBuilder = {
                        id: questions.length, questionText: questionMatch[2], options: [],
                        originalOrder: questionNumber, explanation: ''
                    };
                } else if (optionMatch && currentQuestionBuilder) {
                    let optionText = optionMatch[2];
                    let isCorrectOpt = false;
                    if (optionText.startsWith('**') && optionText.endsWith('**')) {
                        isCorrectOpt = true;
                        optionText = optionText.substring(2, optionText.length - 2);
                        const explanationMatch = optionText.match(explanationRegex);
                        if (explanationMatch) {
                            currentQuestionBuilder.explanation = explanationMatch[1].trim();
                            optionText = optionText.replace(explanationRegex, '').trim();
                        }
                    }
                    currentQuestionBuilder.options.push({ text: optionText.trim(), letter: optionMatch[1], isCorrectOption: isCorrectOpt });
                }
            }
            if (currentQuestionBuilder && currentQuestionBuilder.options.length > 0 && currentQuestionBuilder.options.some(opt => opt.isCorrectOption)) {
                questions.push(currentQuestionBuilder);
            }
            return questions.map(q => ({ ...q, userSelectedOptionLetter: null, isAnsweredCorrectly: null, timeTakenMs: 0, status: 'unanswered' }));
        }
        
        function handleRedoIncorrect() {
            const questionsToRedo = originalAllQuestionsData.filter(q => q.isAnsweredCorrectly === false);
            if (questionsToRedo.length > 0) {
                initializeQuiz(questionsToRedo, true, false, true);
            }
        }

        function handleRedoQuiz() {
            if (originalAllQuestionsData && Array.isArray(originalAllQuestionsData) && originalAllQuestionsData.length > 0) {
                initializeQuiz(originalAllQuestionsData, true, false, false);
            } else {
                commonNewQuizLogic();
            }
        }

        redoIncorrectBtnExt.addEventListener('click', () => {
            showConfirmationModal(
                "Redo Incorrect Questions?",
                "This will start a new quiz with only the questions you answered incorrectly. Are you sure?",
                handleRedoIncorrect,
                'btn-green'
            );
        });

        redoQuizBtnExt.addEventListener('click', () => {
            showConfirmationModal(
                "Retake Quiz?",
                "Are you sure you want to restart the quiz from the beginning?",
                handleRedoQuiz,
                'btn-blue'
            );
        });

        newQuizBtnExt.addEventListener('click', () => {
            showConfirmationModal(
                "Start New Quiz?",
                "This will end your current session and you will lose your results. Are you sure?",
                commonNewQuizLogic,
                'btn-red'
            );
        });


        function initializeQuiz(questionsToUse, shuffle = true, isContinuation = false, isRedoIncorrectMode = false) {
            isQuizActive = true;
            hideExternalResultsButtons();
            currentQuizQuestions = JSON.parse(JSON.stringify(questionsToUse)); 
            if (currentQuizQuestions.length === 0) {
                showFormatErrorModal();
                isQuizActive = false;
                return;
            }
            if (!isContinuation) { 
                currentQuizQuestions.forEach(q => {
                    q.userSelectedOptionLetter = null; q.isAnsweredCorrectly = null;
                    q.timeTakenMs = 0; q.status = 'unanswered';
                });
                accumulatedTotalQuizTimeMs = 0;
                currentQuestionDisplayOrderIndex = 0;
                questionOrder = Array.from(Array(currentQuizQuestions.length).keys());
                if (shuffle) shuffleArray(questionOrder);
            }
            isQuizPaused = false;
            totalQuizTimerStartMs = Date.now(); 
            inputScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            renderTimelineNav();
            navigateToQuestion(currentQuestionDisplayOrderIndex, true, 'next', isRedoIncorrectMode); 
        }

        function getCurrentQuestionData() {
            if (questionOrder.length === 0 || currentQuestionDisplayOrderIndex >= questionOrder.length) return null;
            const questionIndexInCurrentArray = questionOrder[currentQuestionDisplayOrderIndex];
            return currentQuizQuestions[questionIndexInCurrentArray]; 
        }
        
        function buildQuestionDOM(question) {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-instance min-w-full flex-shrink-0 opacity-100 box-border max-w-full';
            const uniqueIdPrefix = `q-${question.id}-inst-${Date.now() % 10000}`;
            questionDiv.innerHTML = `
                <div id="${uniqueIdPrefix}-opts" class="space-y-3 max-w-full"></div>
                <div id="${uniqueIdPrefix}-feedback" class="mt-4 min-h-[50px]"></div>
            `;
            const optsContainer = questionDiv.querySelector(`#${uniqueIdPrefix}-opts`);
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'btn btn-main btn-option';
                button.textContent = `${option.letter}. ${option.text}`;
                button.dataset.letter = option.letter;
                button.addEventListener('click', () => {
                    if (question.isAnsweredCorrectly !== null || isQuizPaused) return; 
                    optsContainer.querySelectorAll('.btn-option').forEach(btn => btn.classList.remove('user-selected-option'));
                    button.classList.add('user-selected-option');
                    selectedOptionLetter = option.letter; 
                    submitAnswerBtn.disabled = false;
                });
                optsContainer.appendChild(button);
            });
            return questionDiv;
        }

        function displayQuestion(isInitialLoad = false, direction = 'next', isRedoIncorrectMode = false) {
            clearTimeout(autoAdvanceTimeout);
            const question = getCurrentQuestionData();
            if (!question) {
                showResults(false, isRedoIncorrectMode); 
                return;
            }
            selectedOptionLetter = null; 
            
            externalPauseBtn.classList.remove('hidden');
            externalSubmitEarlyBtn.classList.remove('hidden');

            if (question.isAnsweredCorrectly !== null) {
                submitAnswerBtn.textContent = currentQuizQuestions.every(q => q.isAnsweredCorrectly !== null) ? "See Results" : "Next Question";
                submitAnswerBtn.disabled = false;
            } else {
                submitAnswerBtn.textContent = "Submit Answer";
                submitAnswerBtn.disabled = true;
            }

            quizScreenTitle.textContent = `Question ${currentQuestionDisplayOrderIndex + 1}`;
            stickyQuestionText.innerHTML = question.questionText;

            const newQuestionDOM = buildQuestionDOM(question);
            questionContentSlider.style.transition = 'none'; 
            if (isInitialLoad || !currentQuestionDOM || questionContentSlider.children.length === 0) { 
                questionContentSlider.innerHTML = ''; questionContentSlider.appendChild(newQuestionDOM);
                questionContentSlider.style.transform = 'translateX(0%)';
            } else {
                if (direction === 'next') {
                    questionContentSlider.appendChild(newQuestionDOM); questionContentSlider.style.transform = `translateX(0%)`; 
                     requestAnimationFrame(() => { 
                        questionContentSlider.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        questionContentSlider.style.transform = 'translateX(-100%)';
                    });
                } else { 
                    questionContentSlider.insertBefore(newQuestionDOM, questionContentSlider.firstChild);
                    questionContentSlider.style.transform = 'translateX(-100%)'; 
                    requestAnimationFrame(() => {
                        questionContentSlider.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        questionContentSlider.style.transform = 'translateX(0%)';
                    });
                }
                setTimeout(() => {
                    if (direction === 'next' && questionContentSlider.children.length > 1) questionContentSlider.removeChild(questionContentSlider.firstChild);
                    else if (direction === 'prev' && questionContentSlider.children.length > 1) questionContentSlider.removeChild(questionContentSlider.lastChild);
                    if (questionContentSlider.children.length === 1) {
                       questionContentSlider.style.transition = 'none'; questionContentSlider.style.transform = 'translateX(0%)';
                    }
                }, 400); 
            }
            currentQuestionDOM = newQuestionDOM; 
            const currentOptsContainer = currentQuestionDOM.querySelector(`[id$="-opts"]`);
            const currentFeedbackContainer = currentQuestionDOM.querySelector(`[id$="-feedback"]`);
            if (question.isAnsweredCorrectly !== null) { 
                showAnswerFeedbackDOM(question, currentFeedbackContainer, currentOptsContainer);
                if (currentOptsContainer) { 
                    currentOptsContainer.querySelectorAll('.btn-option').forEach(btn => {
                        btn.disabled = true; 
                        if (btn.dataset.letter === question.userSelectedOptionLetter) btn.classList.add(question.isAnsweredCorrectly ? 'correct' : 'incorrect');
                        const optData = question.options.find(o => o.letter === btn.dataset.letter);
                        if (optData && optData.isCorrectOption && !question.isAnsweredCorrectly && btn.dataset.letter !== question.userSelectedOptionLetter) btn.classList.add('correct'); 
                    });
                }
                currentQuestionTimerDisplay.textContent = `Time: ${formatTime(question.timeTakenMs)}`;
            } else { 
                questionSpecificTimerStartMs = Date.now() - (question.timeTakenMs || 0); 
                startTimers();
            }
            updateTimelineNav(); centerCurrentTimelineCircle();
        }
        
        function handleSubmitAnswer() { 
            const question = getCurrentQuestionData();
            if (!question || question.isAnsweredCorrectly !== null || !selectedOptionLetter || isQuizPaused) return;

            stopTimers(false); 
            question.timeTakenMs = Date.now() - questionSpecificTimerStartMs;
            question.userSelectedOptionLetter = selectedOptionLetter;
            const correctOption = question.options.find(opt => opt.isCorrectOption);
            question.isAnsweredCorrectly = (selectedOptionLetter === correctOption.letter);
            question.status = question.isAnsweredCorrectly ? 'answered-correct' : 'answered-incorrect';
            const currentFeedbackDOM = currentQuestionDOM ? currentQuestionDOM.querySelector(`[id$="-feedback"]`) : null;
            const currentOptsDOM = currentQuestionDOM ? currentQuestionDOM.querySelector(`[id$="-opts"]`) : null;
            if (currentFeedbackDOM && currentOptsDOM) { 
                showAnswerFeedbackDOM(question, currentFeedbackDOM, currentOptsDOM);
                updateTimelineNav();
                currentOptsDOM.querySelectorAll('.btn-option').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.letter === selectedOptionLetter) btn.classList.add(question.isAnsweredCorrectly ? 'correct' : 'incorrect');
                    if (!question.isAnsweredCorrectly && question.options.find(o => o.letter === btn.dataset.letter && o.isCorrectOption)) btn.classList.add('correct'); 
                });
            }
            const allAnswered = currentQuizQuestions.every(q => q.isAnsweredCorrectly !== null);
            if (allAnswered) {
                submitAnswerBtn.textContent = "See Results"; submitAnswerBtn.disabled = false;
                externalPauseBtn.classList.add('hidden'); externalSubmitEarlyBtn.classList.add('hidden');
                autoAdvanceTimeout = setTimeout(() => {
                    if (isQuizActive && !isQuizPaused) {
                        const isRedoMode = quizScreenTitle.textContent.includes("Redo Incorrect Questions");
                        showResults(false, isRedoMode);
                    }
                }, 1200); 
                return;
            }
            submitAnswerBtn.textContent = "Next Question"; submitAnswerBtn.disabled = false;
            if (question.isAnsweredCorrectly) autoAdvanceTimeout = setTimeout(() => { if (!isQuizPaused) handleNextAction(); }, 1000);
        }

        function showAnswerFeedbackDOM(question, feedbackEl, optionsEl) {
            if (!feedbackEl || !optionsEl) return;
            let feedbackMsg = '';
            if (question.isAnsweredCorrectly) {
                feedbackMsg = `<div class="feedback-message feedback-correct"><strong>Correct!</strong> Well done.</div>`;
            } else {
                const correctOpt = question.options.find(opt => opt.isCorrectOption);
                let explanationText = `<strong>Incorrect.</strong> The correct answer was: <strong>${correctOpt.letter}. ${correctOpt.text}</strong>`;
                if (question.explanation) {
                    explanationText = `<div class="p-2">
                        <p class="font-semibold">The correct answer is ${correctOpt.letter}. Here's why:</p>
                        <p class="mt-1 text-sm">${question.explanation}</p>
                    </div>`;
                }
                feedbackMsg = `<div class="feedback-message feedback-incorrect">${explanationText}</div>`;
            }
            feedbackEl.innerHTML = feedbackMsg;
        }
        
        function handleNextAction() { 
            clearTimeout(autoAdvanceTimeout);
            const question = getCurrentQuestionData();
            if(question && question.isAnsweredCorrectly === null) { handleSubmitAnswer(); return; }
            const isRedoMode = quizScreenTitle.textContent.includes("Redo Incorrect Questions");
            if (currentQuizQuestions.every(q => q.isAnsweredCorrectly !== null)) { showResults(false, isRedoMode); return; }
            let foundNext = false;
            for (let i = 1; i < currentQuizQuestions.length; i++) {
                const nextDisplayIdx = (currentQuestionDisplayOrderIndex + i) % currentQuizQuestions.length;
                const nextQuestionIndexInCurrent = questionOrder[nextDisplayIdx];
                if (currentQuizQuestions[nextQuestionIndexInCurrent].isAnsweredCorrectly === null) {
                    navigateToQuestion(nextDisplayIdx, false, 'next', isRedoMode); foundNext = true; break;
                }
            }
            if (!foundNext) showResults(false, isRedoMode);
        }

        function startTimers() {
            stopTimers(false); 
            currentQuestionTimerDisplay.textContent = `Time: ${formatTime(Date.now() - questionSpecificTimerStartMs)}`;
            currentTimerInterval = setInterval(() => {
                if (isQuizPaused) return;
                const qTime = Date.now() - questionSpecificTimerStartMs;
                currentQuestionTimerDisplay.textContent = `Time: ${formatTime(qTime)}`;
            }, 1000);
        }
        function stopTimers(isPausingOrEndingQuiz = false) {
            clearInterval(currentTimerInterval); currentTimerInterval = null;
            if (isPausingOrEndingQuiz && totalQuizTimerStartMs > 0) { 
                accumulatedTotalQuizTimeMs += (Date.now() - totalQuizTimerStartMs); totalQuizTimerStartMs = 0; 
            }
        }
        function navigateToQuestion(displayOrderIndex, isInitial = false, direction = 'next', isRedoIncorrectMode = false) {
            const oldQuestion = getCurrentQuestionData();
            if (oldQuestion && oldQuestion.isAnsweredCorrectly === null && questionSpecificTimerStartMs > 0) oldQuestion.timeTakenMs = Date.now() - questionSpecificTimerStartMs; 
            stopTimers(false);
            currentQuestionDisplayOrderIndex = displayOrderIndex;
            displayQuestion(isInitial, direction, isRedoIncorrectMode); 
        }

        function renderTimelineNav() { 
            timelineNavTrack.innerHTML = '';
            questionOrder.forEach((questionIndexInCurrentArray, indexInDisplayOrder) => { 
                const questionData = currentQuizQuestions[questionIndexInCurrentArray];
                if (!questionData) return;
                const circle = document.createElement('div');
                circle.className = 'timeline-circle';
                circle.textContent = indexInDisplayOrder + 1; 
                circle.dataset.displayOrderIndex = indexInDisplayOrder;
                circle.id = `timeline-circle-${indexInDisplayOrder}`;
                if (questionData.status === 'answered-correct') circle.classList.add('answered-correct');
                else if (questionData.status === 'answered-incorrect') circle.classList.add('answered-incorrect');
                if (indexInDisplayOrder === currentQuestionDisplayOrderIndex) circle.classList.add('current');
                circle.addEventListener('click', () => {
                    if (isQuizPaused) return;
                    const isRedoMode = quizScreenTitle.textContent.includes("Redo Incorrect Questions");
                    navigateToQuestion(indexInDisplayOrder, false, indexInDisplayOrder > currentQuestionDisplayOrderIndex ? 'next' : 'prev', isRedoMode);
                });
                timelineNavTrack.appendChild(circle);
                if (indexInDisplayOrder < questionOrder.length - 1) {
                    const line = document.createElement('div');
                    line.className = 'timeline-line';
                    timelineNavTrack.appendChild(line);
                }
            });
            updateTimelineNav(); requestAnimationFrame(centerCurrentTimelineCircle); 
        }
        function updateTimelineNav() { 
            timelineNavTrack.querySelectorAll('.timeline-circle').forEach(circle => {
                const displayIdx = parseInt(circle.dataset.displayOrderIndex);
                const questionIndexInCurrentArray = questionOrder[displayIdx];
                const questionData = currentQuizQuestions[questionIndexInCurrentArray];
                if (!questionData) return;
                circle.classList.remove('current', 'answered-correct', 'answered-incorrect');
                if (questionData.status === 'answered-correct') circle.classList.add('answered-correct');
                else if (questionData.status === 'answered-incorrect') circle.classList.add('answered-incorrect');
                if (displayIdx === currentQuestionDisplayOrderIndex) circle.classList.add('current');
            });
        }
        function centerCurrentTimelineCircle() { 
            const currentCircle = document.getElementById(`timeline-circle-${currentQuestionDisplayOrderIndex}`);
            if (currentCircle && timelineNavContainer) { 
                const containerWidth = timelineNavContainer.offsetWidth;
                const scrollLeftTarget = currentCircle.offsetLeft - (containerWidth / 2) + (currentCircle.offsetWidth / 2);
                timelineNavContainer.scrollTo({ left: scrollLeftTarget, behavior: 'smooth' });
            }
        }
        
        timelineNavContainer.addEventListener('mousedown', (e) => { isTimelineDragging = true; timelineStartX = e.pageX - timelineNavContainer.offsetLeft; timelineScrollLeftStart = timelineNavContainer.scrollLeft; });
        timelineNavContainer.addEventListener('mouseleave', () => { isTimelineDragging = false; });
        timelineNavContainer.addEventListener('mouseup', () => { isTimelineDragging = false; });
        timelineNavContainer.addEventListener('mousemove', (e) => {
            if (!isTimelineDragging) return; e.preventDefault();
            const x = e.pageX - timelineNavContainer.offsetLeft;
            const walk = (x - timelineStartX) * 1.5; 
            timelineNavContainer.scrollLeft = timelineScrollLeftStart - walk;
        });

        function pauseQuiz() {
            if (isQuizPaused) return; 
            isQuizPaused = true; 
            stopTimers(true); 
            const currentQ = getCurrentQuestionData();
            if (currentQ && currentQ.isAnsweredCorrectly === null && questionSpecificTimerStartMs > 0) currentQ.timeTakenMs = Date.now() - questionSpecificTimerStartMs;
            
            let answeredCount = 0; let correctCount = 0;
            currentQuizQuestions.forEach(q => { if (q.isAnsweredCorrectly !== null) { answeredCount++; if (q.isAnsweredCorrectly) correctCount++; } });
            const answeredPercentage = answeredCount > 0 ? ((correctCount / answeredCount) * 100).toFixed(1) : 0;
            pausedScoreDisplay.textContent = `${correctCount}/${answeredCount} (${answeredPercentage}%)`;
            pausedRemainingDisplay.textContent = currentQuizQuestions.filter(q => q.isAnsweredCorrectly === null).length;
            pausedTimeDisplay.textContent = formatTime(accumulatedTotalQuizTimeMs);
            
            pauseModal.classList.add('visible');
        }

        function resumeQuiz() {
            isQuizPaused = false; 
            pauseModal.classList.remove('visible');
            totalQuizTimerStartMs = Date.now(); 
            const currentQ = getCurrentQuestionData();
            if (currentQ && currentQ.isAnsweredCorrectly === null) { 
                questionSpecificTimerStartMs = Date.now() - (currentQ.timeTakenMs || 0); startTimers();
            } else if (currentQ) currentQuestionTimerDisplay.textContent = `Time: ${formatTime(currentQ.timeTakenMs || 0)}`;
        }
        externalPauseBtn.addEventListener('click', pauseQuiz);
        resumeQuizBtn.addEventListener('click', resumeQuiz);

        function showConfirmationModal(title, message, onConfirm, confirmBtnClass = 'btn-red') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmActionCallback = onConfirm;
            
            // Dynamically set button color
            modalConfirmBtn.className = 'btn'; // Reset classes
            modalConfirmBtn.classList.add(confirmBtnClass);
            modalConfirmBtn.textContent = 'Confirm';


            confirmationModal.classList.add('visible');
        }
        modalCancelBtn.addEventListener('click', () => { confirmationModal.classList.remove('visible'); confirmActionCallback = null; });
        modalConfirmBtn.addEventListener('click', () => { if (confirmActionCallback) confirmActionCallback(); confirmationModal.classList.remove('visible'); confirmActionCallback = null; });
        
        function endQuizPrematurelyAction() {
            isQuizActive = false; isQuizPaused = true; stopTimers(true);
            const currentQ = getCurrentQuestionData();
            if (currentQ && currentQ.isAnsweredCorrectly === null && questionSpecificTimerStartMs > 0) currentQ.timeTakenMs = Date.now() - questionSpecificTimerStartMs;
            const isRedoMode = quizScreenTitle.textContent.includes("Redo Incorrect Questions");
            pauseModal.classList.remove('visible');
            showResults(true, isRedoMode); 
        }
        endQuizEarlyBtn.addEventListener('click', () => showConfirmationModal("End Quiz?", "Are you sure you want to end the quiz now? Your current progress will be shown.", endQuizPrematurelyAction, 'btn-red')); 
        externalSubmitEarlyBtn.addEventListener('click', () => showConfirmationModal("Submit Quiz?", "Are you sure you want to submit the quiz now? You cannot answer more questions.", endQuizPrematurelyAction, 'btn-red')); 

        function showResults(isPrematureEnd = false, wasRedoIncorrectMode = false) {
            isQuizActive = false; stopTimers(true); isQuizPaused = true;
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
            externalPauseBtn.classList.add('hidden'); externalSubmitEarlyBtn.classList.add('hidden');
            
            redoQuizBtnExt.classList.remove('hidden'); 
            newQuizBtnExt.classList.remove('hidden');
            
            resultsTitle.textContent = isPrematureEnd ? "Quiz Submitted Early" : "Quiz Complete!";
            
            if (!wasRedoIncorrectMode) {
                currentQuizQuestions.forEach(cq => {
                    const originalQ = originalAllQuestionsData.find(oq => oq.id === cq.id);
                    if (originalQ) { Object.assign(originalQ, { isAnsweredCorrectly: cq.isAnsweredCorrectly, userSelectedOptionLetter: cq.userSelectedOptionLetter, status: cq.status, timeTakenMs: cq.timeTakenMs }); }
                });
            }

            let correctAnswers = 0, answeredQuestionsCount = 0;
            currentQuizQuestions.forEach(q => { if (q.isAnsweredCorrectly !== null) answeredQuestionsCount++; if (q.isAnsweredCorrectly) correctAnswers++; });
            
            const totalQuestionsInSet = currentQuizQuestions.length;
            const percentage = totalQuestionsInSet > 0 ? ((correctAnswers / totalQuestionsInSet) * 100) : 0;
            
            scorePercentageDisplay.textContent = `${percentage.toFixed(1)}%`;
            scoreDetailsDisplay.textContent = `${correctAnswers} / ${totalQuestionsInSet} correct`;
            totalQuizTimeDisplay.textContent = formatTime(accumulatedTotalQuizTimeMs);
            
            scoreDisplayContainer.className = 'flex justify-between items-center p-4 rounded-lg transition-colors duration-500 mb-4';
            if (isPrematureEnd) {
                scoreDisplayContainer.classList.add('default');
                scoreMessageDisplay.textContent = `You answered ${answeredQuestionsCount} of ${totalQuestionsInSet} questions.`;
            } else {
                const roundedPercentage = Math.round(percentage);
                if (roundedPercentage === 100) { scoreDisplayContainer.classList.add('gold'); scoreMessageDisplay.textContent = "Excellent Work!"; } 
                else if (roundedPercentage >= 80) { scoreDisplayContainer.classList.add('silver'); scoreMessageDisplay.textContent = "Almost There!"; } 
                else if (roundedPercentage >= 65) { scoreDisplayContainer.classList.add('bronze'); scoreMessageDisplay.textContent = "Needs Work!"; } 
                else { scoreDisplayContainer.classList.add('default'); scoreMessageDisplay.textContent = "Keep Practicing!"; }
            }

            resultsDetailsContainer.innerHTML = '';
            const questionsToReview = questionOrder.map(qIndex => currentQuizQuestions[qIndex]);
            questionsToReview.forEach((question, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `result-question-item ${question.isAnsweredCorrectly === true ? 'correct' : question.isAnsweredCorrectly === false ? 'incorrect' : 'unanswered'}`;
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center cursor-pointer">
                        <span class="font-semibold">${index + 1}. ${question.questionText}</span>
                        <div class="flex items-center">
                            <span class="text-xs text-gray-500 mr-2">Time: ${formatTime(question.timeTakenMs || 0)}</span>
                            <svg class="dropdown-arrow w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div class="result-options-container pl-4 ml-1"></div>`;
                const optionsDiv = itemDiv.querySelector('.result-options-container');
                if (question.options && question.options.length > 0) {
                    question.options.forEach(opt => {
                        const optP = document.createElement('p');
                        optP.className = 'result-option text-sm';
                        optP.textContent = `${opt.letter}. ${opt.text}`;
                        if (opt.isCorrectOption) optP.classList.add('correct-answer');
                        if (opt.letter === question.userSelectedOptionLetter) {
                            optP.classList.add('user-selected');
                            if (!question.isAnsweredCorrectly && question.userSelectedOptionLetter !== null) optP.classList.add('incorrect-answer');
                        }
                        optionsDiv.appendChild(optP);
                    });
                    if (question.explanation) {
                        const explanationDiv = document.createElement('div');
                        explanationDiv.className = 'explanation-container mt-3';
                        explanationDiv.innerHTML = `<p class="font-semibold text-sm">Explanation:</p><p class="text-sm">${question.explanation}</p>`;
                        optionsDiv.appendChild(explanationDiv);
                    }
                }
                resultsDetailsContainer.appendChild(itemDiv);
                itemDiv.querySelector('.cursor-pointer').addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    optionsDiv.classList.toggle('expanded');
                    target.querySelector('.dropdown-arrow').classList.toggle('expanded');
                });
            });

            const sourceForRedoCheck = wasRedoIncorrectMode ? currentQuizQuestions : originalAllQuestionsData;
            const incorrectForRedoButton = sourceForRedoCheck.filter(q => q.isAnsweredCorrectly === false);
            if (incorrectForRedoButton.length > 0) {
                redoIncorrectBtnExt.classList.remove('hidden');
            } else {
                redoIncorrectBtnExt.classList.add('hidden');
            }
        }

        function hideExternalResultsButtons() {
            redoIncorrectBtnExt.classList.add('hidden');
            redoQuizBtnExt.classList.add('hidden');
            newQuizBtnExt.classList.add('hidden');
        }

        createQuizBtn.addEventListener('click', () => {
            const rawData = quizDataInput.value;
            if (!rawData.trim()) { showFormatErrorModal(); return; }
            originalAllQuestionsData = parseInput(rawData);
            if (originalAllQuestionsData.length === 0) { showFormatErrorModal(); return; }
            initializeQuiz(originalAllQuestionsData, true, false, false); 
        });

        submitAnswerBtn.addEventListener('click', handleNextAction);

        const commonNewQuizLogic = () => { 
            isQuizActive = false; hideExternalResultsButtons();
            resultsScreen.classList.add('hidden');
            quizScreen.classList.add('hidden'); externalPauseBtn.classList.add('hidden');
            externalSubmitEarlyBtn.classList.add('hidden'); inputScreen.classList.remove('hidden');
            quizDataInput.value = ''; 
            textareaPlaceholder.style.display = 'flex';
            originalAllQuestionsData = []; currentQuizQuestions = [];
            questionOrder = []; currentQuestionDisplayOrderIndex = 0;
            accumulatedTotalQuizTimeMs = 0; stopTimers(true); isQuizPaused = false; 
            currentQuestionDOM = null; questionContentSlider.innerHTML = ''; 
        };
        
        redoQuizPausedBtn.addEventListener('click', () => {
            showConfirmationModal(
                "Retake Quiz?", 
                "Are you sure you want to discard your paused progress and restart?",
                () => {
                    pauseModal.classList.remove('visible');
                    handleRedoQuiz();
                },
                'btn-blue'
            );
        });
       
        const aiModelData = {
            'chatgpt': { max: 35, format: 'not-defined' },
            'chatgpt-plus': { max: 100, format: 'not-defined' },
            'notebook-lm': { max: 50, format: 'notebook-lm-format' },
            'gemini': { max: 15, format: 'not-defined' },
            'claude': { max: 5, format: 'not-defined' },
            'deepseek': { max: 5, format: 'not-defined' },
            'llama': { max: 5, format: 'not-defined' }
        };

        const promptFormats = {
            'not-defined': 'Prompt not defined for this model.',
            'notebook-lm-format': `
Numbered Questions: Each question starts with 1., 2., etc.
Lettered Options: Options for each question are A., B., C., D.
No blank lines between questions and their options, or between options of the same question. Use a blank line to separate different questions.
Explanation: Immediately after the correct answer's text, add [explanation] followed by the explanation. 
Do not mention the source, rather explain why the correct answer is correct and do not just restate the correct answer.
The correct answer should have ** around it and its explanation. This is a must. It should also be bolded.
Example of Correct answer that has bold text and ** surround it: **B. This is correct [explanation] Because of this reason.**
One Correct Answer: Only one correct answer per question.
All options (correct and incorrect) must seem plausible.
At least one wrong answer choice must be at least 3 characters longer than the correct answer choice.
At least one wrong answer choice must be at least 3 characters shorter than the correct answer choice.
The correct answers shouldn't be evenly distributed among A, B, C, D.
No single answer letter (A, B, C, or D) can have less than 10% of the total correct answers.
Example: 35% A, 10% B, 25% C, 30% D is valid.
Do not include any other text before or after the questions and answers.
Example Question Formatting:
1. Which planet is known as the Red Planet?
    A. Venus.
    B. **Mars. [explanation] Mars is often called the Red Planet due to its iron oxide-rich surface.**
    C. Jupiter.
    D. Earth.
`,
            'chatgpt-format': `Please generate a series of multiple-choice questions. For each question, provide four options labeled A, B, C, and D. Indicate the correct answer clearly by bolding it and adding a brief explanation in brackets. Ensure there are no extra line breaks between a question and its options. Separate each question block with a single blank line. The difficulty should be varied, and the position of the correct answer should be randomized.`,
            'chatgpt-plus-format': `Produce a set of high-quality multiple-choice questions. Each question must have four plausible options (A, B, C, D). The correct option must be bolded and followed by a detailed explanation within brackets, like so: **Correct Answer [explanation]**. Maintain a compact format with no blank lines within a question block, but use one blank line to separate each question from the next. The distribution of correct answers (A, B, C, D) should be uneven.`,
            'gemini-format': `Create a multiple-choice quiz. Follow these rules strictly: - Start each question with a number (1., 2., ...). - Provide four options: A., B., C., D. - The correct answer MUST be enclosed in double asterisks (e.g., **B. Answer here**). - Immediately after the correct answer text, provide an explanation in the format [explanation]...[/explanation]. - Do not use blank lines between a question and its set of options.`
        };

        function updateQuestionCount(value) {
            const selectedModel = hiddenSelectInput.value;
            const maxQuestions = (selectedModel && aiModelData[selectedModel]?.max) || 100;
            let numValue = parseInt(value, 10);
            if (isNaN(numValue) || numValue < 1) numValue = 1;
            else if (numValue > maxQuestions) numValue = maxQuestions;
            questionCountInput.value = numValue;
            localStorage.setItem('savedQuestionCount', numValue);
        }
        
        questionCountInput.addEventListener('input', (e) => updateQuestionCount(e.target.value));
        qCountMinusBtn.addEventListener('click', () => updateQuestionCount(parseInt(questionCountInput.value, 10) - 1));
        qCountPlusBtn.addEventListener('click', () => updateQuestionCount(parseInt(questionCountInput.value, 10) + 1));
        qCountMaxBtn.addEventListener('click', () => { const selectedModel = hiddenSelectInput.value; if (selectedModel && aiModelData[selectedModel]) updateQuestionCount(aiModelData[selectedModel].max); });
        
        copyFormatBtn.addEventListener('click', () => {
            const model = hiddenSelectInput.value; const qCount = questionCountInput.value;
            if (!model || !qCount || qCount < 1) {
                clearTimeout(copyTimeout);
                copyFormatBtn.textContent = 'Select Model & Question Amount First!';
                copyFormatBtn.classList.remove('btn-main', 'btn-green'); copyFormatBtn.classList.add('btn-red');
                copyTimeout = setTimeout(() => { copyFormatBtn.textContent = 'Required Prompt. Click to Copy'; copyFormatBtn.classList.remove('btn-red'); copyFormatBtn.classList.add('btn-main'); }, 3000);
                return;
            }
            const formatId = aiModelData[model].format; const formatText = promptFormats[formatId];
            const fullPrompt = `Create a ${qCount} question multiple choice quiz. You must follow the required formatting presented below and should never deviate from it for any reason.\n\n${formatText}`;
            navigator.clipboard.writeText(fullPrompt).then(() => {
                clearTimeout(copyTimeout); copyFormatBtn.textContent = 'Copied! Paste into your AI Model.';
                copyFormatBtn.classList.remove('btn-main', 'btn-red'); copyFormatBtn.classList.add('btn-green');
                copyTimeout = setTimeout(() => { copyFormatBtn.textContent = 'Required Prompt. Click to Copy'; copyFormatBtn.classList.remove('btn-green'); copyFormatBtn.classList.add('btn-main'); }, 3000); 
            }).catch(err => { console.error('Failed to copy text: ', err); });
        });

        function getOrdinalSuffix(day) {
            if (day > 3 && day < 21) return 'th';
            switch (day % 10) {
                case 1:  return "st";
                case 2:  return "nd";
                case 3:  return "rd";
                default: return "th";
            }
        }
        function getFormattedDate() {
            const date = new Date();
            const day = date.getDate();
            const month = date.toLocaleDateString('en-GB', { month: 'long' });
            const year = date.getFullYear();
            return `${day}${getOrdinalSuffix(day)} ${month} ${year}`;
        }

        function setupCustomSelect() {
            customSelectTrigger.addEventListener('click', () => {
                customSelectOptions.classList.toggle('hidden');
            });

            document.querySelectorAll('.custom-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    if (e.currentTarget.classList.contains('disabled')) return;
                    
                    const value = e.currentTarget.dataset.value;
                    const text = e.currentTarget.textContent;

                    hiddenSelectInput.value = value;
                    customSelectValue.textContent = text;
                    customSelectOptions.classList.add('hidden');
                    
                    updateQuestionCount(questionCountInput.value);
                    localStorage.setItem('savedAiModel', value);
                });
            });

            document.addEventListener('click', (e) => {
                if (!customSelectContainer.contains(e.target)) {
                    customSelectOptions.classList.add('hidden');
                }
            });
        }

        function loadPromptBuilderSettings() {
            const savedModel = localStorage.getItem('savedAiModel');
            const savedCount = localStorage.getItem('savedQuestionCount');
            
            if (savedModel) {
                 const option = document.querySelector(`.custom-option[data-value="${savedModel}"]`);
                 if (option) {
                    hiddenSelectInput.value = savedModel;
                    customSelectValue.textContent = option.textContent;
                 }
            }
            if(savedCount) { 
                questionCountInput.value = savedCount; 
                updateQuestionCount(savedCount);
            } else {
                updateQuestionCount(10); // Default
            }

            const formattedDate = getFormattedDate();
            if(todayDateSpan) todayDateSpan.textContent = formattedDate;
        }
        
        quizDataInput.addEventListener('input', () => {
            textareaPlaceholder.style.display = quizDataInput.value ? 'none' : 'flex';
        });

        function showFormatErrorModal() { formatErrorModal.classList.add('visible'); }
        formatModalOkBtn.addEventListener('click', () => formatErrorModal.classList.remove('visible'));

        function setQuizContainerHeight() {
            const topControls = document.querySelector('.top-controls-area');
            const footer = document.querySelector('.app-footer');
            const quizContainer = document.querySelector('.quiz-container');

            if (!topControls || !footer || !quizContainer) return;

            const topHeight = topControls.offsetHeight;
            const footerHeight = footer.offsetHeight;
            
            const verticalMargin = 56; // Represents 1rem top margin + 2rem bottom margin
            
            const availableHeight = window.innerHeight - topHeight - footerHeight - verticalMargin;
            
            quizContainer.style.height = `${availableHeight}px`;
        }

        window.addEventListener('beforeunload', (e) => { if (isQuizActive) { e.preventDefault(); e.returnValue = ''; } });
        window.addEventListener('DOMContentLoaded', () => {
            loadTheme(); 
            resizeSmudgeCanvas(); 
            animateSmudgeBackground(); 
            setupCustomSelect();
            loadPromptBuilderSettings();
            setQuizContainerHeight(); 
            window.addEventListener('resize', () => {
                resizeSmudgeCanvas();
                setQuizContainerHeight();
            }); 
        });
    </script>
</body>
</html>
